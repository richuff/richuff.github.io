<!DOCTYPE html>
<html>
  <head>
     
    <meta charset="UTF-8">
    <title>Nginx - Richu</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <meta property="og:site_name" content="Richu">
    <meta property="og:title" content="Nginx"/>
    
    <style>body:before{ content: ''; background-image: url(https://img.meituan.net/csc/d05518606ba7064dd445508e3cf3d4c42860983.png) }</style>
    
<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
    <div class="head-title">
        <h4>Richu</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/Android/">Android</a><a class="category-link" href="/categories/Go/">Go</a><a class="category-link" href="/categories/Java/">Java</a><a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><a class="category-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>Nginx</h2>
            <div class="post-meta">
                <time class="date">2024.08.31</time>
            
                <span class="category"><a class="category-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></span>
            
            </div>
        </section>
        <article class="post-content">
        
            <p>nginx is an HTTP and reverse proxy server, a mail proxy server, and a generic<br>TCP/UDP proxy server, originally written by Igor Sysoev.</p>
<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="1-Nginx功能特性"><a href="#1-Nginx功能特性" class="headerlink" title="1.Nginx功能特性"></a>1.Nginx功能特性</h2><h3 id="1-1-Nginx常用的功能模块"><a href="#1-1-Nginx常用的功能模块" class="headerlink" title="1.1.Nginx常用的功能模块"></a>1.1.Nginx常用的功能模块</h3><blockquote>
<p>静态资源的部署</p>
<p>Rewrite地址重写</p>
<p>​	正则表达式</p>
<p>方向代理</p>
<p>负载均衡</p>
<ul>
<li>轮询，加权轮询,ip_hash,url_hash,fair</li>
</ul>
<p>Web缓存</p>
<p>环境部署</p>
<ul>
<li>高可用的环境</li>
</ul>
<p>用户认证模块</p>
</blockquote>
<h3 id="1-2-Nginx的核心组成"><a href="#1-2-Nginx的核心组成" class="headerlink" title="1.2.Nginx的核心组成"></a>1.2.Nginx的核心组成</h3><blockquote>
<p>nginx二进制可执行文件</p>
<p>nginx.conf配置文件</p>
<p>error.log错误的日志记录</p>
<p>access.log访问日志记录</p>
</blockquote>
<h2 id="2-Nginx环境配置"><a href="#2-Nginx环境配置" class="headerlink" title="2.Nginx环境配置"></a>2.Nginx环境配置</h2><h3 id="1-环境配置"><a href="#1-环境配置" class="headerlink" title="1.环境配置"></a>1.环境配置</h3><p><a target="_blank" rel="noopener" href="https://nginx.org/download/">Index of &#x2F;download&#x2F; (nginx.org)</a></p>
<blockquote>
<p>使用sestatus查看，将sestatus关闭</p>
</blockquote>
<pre><code class="highlight plaintext">vim /etc/selinux/config</code></pre>

<blockquote>
<p>修改SELINUX&#x3D;disabled</p>
</blockquote>
<h3 id="2-通过nginx源码安装"><a href="#2-通过nginx源码安装" class="headerlink" title="2.通过nginx源码安装"></a>2.通过nginx源码安装</h3><p>1.gcc</p>
<blockquote>
<p>yum install -y  gcc</p>
</blockquote>
<p>2.pcre</p>
<blockquote>
<p>yum install -y pcre  pcre-devel</p>
</blockquote>
<p>3.zlib</p>
<blockquote>
<p>yum install -y zlib zlib-devel</p>
</blockquote>
<p>4.openSSL</p>
<blockquote>
<p>yum install -y openssl openssl-devel</p>
</blockquote>
<p>5.使用wget安装</p>
<pre><code class="highlight plaintext">wget https://nginx.org/download/nginx-1.26.1.tar.gz
//创建文件，便于管理
mkdir -p nginx/core
mv nginx-1.26.1.tar.gz nginx/core</code></pre>

<p>6.解压缩</p>
<pre><code class="highlight plaintext">tar -xzf nginx-1.26.1.tar.gz</code></pre>

<p>7.进入</p>
<p><code>./configure</code></p>
<p>8.编译</p>
<blockquote>
<p>没有make可以安装一下</p>
<p>yum -y install make</p>
</blockquote>
<p><code>make</code></p>
<p>9.安装</p>
<p><code>make install</code></p>
<blockquote>
<p>没有指定安装目录，可能在&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin</p>
<p>.&#x2F;nginx</p>
</blockquote>
<blockquote>
<p>在浏览器输入ip访问nginx</p>
<p>当结果为如下界面时，测试成功</p>
</blockquote>
<p><img src="https://img.meituan.net/csc/38d9f46c26ada34f19cbc4d4c46fd04551679.png" alt="2024-08-03 195207.png"></p>
<h3 id="3-通过yum安装"><a href="#3-通过yum安装" class="headerlink" title="3.通过yum安装"></a>3.通过yum安装</h3><blockquote>
<p>yum install -y yum-utils</p>
<p>sudo yum install -y nginx</p>
</blockquote>
<h3 id="4-通过nginx源码进行复杂安装"><a href="#4-通过nginx源码进行复杂安装" class="headerlink" title="4.通过nginx源码进行复杂安装"></a>4.通过nginx源码进行复杂安装</h3><blockquote>
<p>安装目录</p>
</blockquote>
<p>–prefix&#x3D;PATH</p>
<blockquote>
<p>指向执行程序文件路径</p>
</blockquote>
<p>–sbin-path&#x3D;PATH</p>
<blockquote>
<p>指向nginx.conf的路径</p>
</blockquote>
<p>–conf-path&#x3D;PATH</p>
<blockquote>
<p>重新卸载nginx</p>
<p>rm -rf  &#x2F;usr&#x2F;local&#x2F;nginx</p>
<p>make clean</p>
</blockquote>
<pre><code class="highlight plaintext">./configure --prefix=/usr/local/
nginx --sbin-path=/usr/local/nginx/sbin/nginx --modules-path=/usr/
local/nginx/modules --conf-path=/usr/local/nginx/conf/nginx.conf 
--error-log-path=/usr/local/nginx/logs/error.log --http-log-path=/
usr/local/nginx/logs/access.log --pid-path=/usr/local/nginx/logs/
nginx.pid --lock-path=/usr/local/nginx/logs/nginx.lock</code></pre>

<p>5.Nginx目录结构</p>
<blockquote>
<p>yum install -y tree  使用tree来查看项目结构</p>
</blockquote>
<blockquote>
<p>CGI通用网关（接口），从客户端发送一个请求和数据，服务端获取到请求和数据可以调用CGI程序处理及相应结果给客户端的一种标准规范</p>
</blockquote>
<blockquote>
<p>[root@localhost sbin]# tree &#x2F;usr&#x2F;local&#x2F;nginx<br>&#x2F;usr&#x2F;local&#x2F;nginx<br>├── client_body_temp<br>├── conf<br>│   ├── fastcgi.conf<br>│   ├── fastcgi.conf.default<br>│   ├── fastcgi_params<br>│   ├── fastcgi_params.default<br>│   ├── koi-utf<br>│   ├── koi-win<br>│   ├── mime.types<br>│   ├── mime.types.default<br>│   ├── nginx.conf<br>│   ├── nginx.conf.default<br>│   ├── scgi_params<br>│   ├── scgi_params.default<br>│   ├── uwsgi_params<br>│   ├── uwsgi_params.default<br>│   └── win-utf<br>├── fastcgi_temp<br>├── html<br>│   ├── 50x.html<br>│   └── index.html<br>├── logs<br>│   ├── access.log<br>│   ├── error.log<br>│   └── nginx.pid<br>├── proxy_temp<br>├── sbin<br>│   └── nginx<br>├── scgi_temp<br>└── uwsgi_temp</p>
</blockquote>
<h2 id="3-Nginx服务的启停"><a href="#3-Nginx服务的启停" class="headerlink" title="3.Nginx服务的启停"></a>3.Nginx服务的启停</h2><blockquote>
<p>1.Nginx服务的信号控制</p>
<p>2.Nginx的命令行控制</p>
</blockquote>
<h3 id="3-1-Nginx服务的信号控制"><a href="#3-1-Nginx服务的信号控制" class="headerlink" title="3.1.Nginx服务的信号控制"></a>3.1.Nginx服务的信号控制</h3><blockquote>
<p>nginx默认采用多进程的方式来工作</p>
<p>ps -ef | grep nginx</p>
</blockquote>
<pre><code class="highlight plaintext">root       31002       1  0 09:36 ?        
00:00:00 nginx: master process ./nginx

nobody     31003   31002  0 09:36 ?        
00:00:00 nginx: worker process

root       87869    2359  0 10:00 pts/0    
00:00:00 grep --color=auto nginx</code></pre>

<blockquote>
<p>发送信号给master进程来控制worker进程等</p>
</blockquote>
<h3 id="3-2-信号"><a href="#3-2-信号" class="headerlink" title="3.2.信号"></a>3.2.信号</h3><table>
<thead>
<tr>
<th>信号</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>TERM&#x2F;INT</td>
<td>立即关闭服务</td>
</tr>
<tr>
<td>QUIT</td>
<td>等待并关闭服务</td>
</tr>
<tr>
<td>HUP</td>
<td>重读配置文件并使用</td>
</tr>
<tr>
<td>USR1</td>
<td>重新打开日志文件,可以用来进行日志切割</td>
</tr>
<tr>
<td>USR2</td>
<td>平滑升级到最新的Nginx</td>
</tr>
<tr>
<td>WINCH</td>
<td>给所有work进程发送QUIT指令</td>
</tr>
</tbody></table>
<blockquote>
<p>kill -signal pid</p>
<p>例：</p>
<pre><code> kill -QUIT 13636
</code></pre>
<p>​	kill -QUIT `more ..&#x2F;logs&#x2F;nginx.pid&#96;</p>
</blockquote>
<blockquote>
<p>发送USR2信号给master进程，告诉master进程要平滑升级，这个时候，会重新开启对应的master进程和work进程，整个系统中将会有两个master进程，并且新的master进程的PID会被记录在&#x2F;usr&#x2F;1oca1&#x2F;nginx&#x2F;1ogs&#x2F;nginx.pid而之前的旧的master进程PID会被记录在&#x2F;usr&#x2F;1oca1&#x2F;nginx&#x2F;1ogs&#x2F;nginx.pid.oldbin文件中，接着再次发送QUIT信号给旧的master进程，让其处理完请求后再进行关闭<br><br/>kill -USR2 PID &#x2F; kill -USR2 ‘cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid”</p>
<p>kill -QUIT PID &#x2F; kill -QUIT `cat &#x2F;usr&#x2F;loca1&#x2F;nginx&#x2F;1ogs&#x2F;nginx.pid.oldbin&#96;</p>
</blockquote>
<blockquote>
<p>发送WINCH信号给master进程，让master进程控制不让所有的work进程在接收新的请求了，请求处理完后关闭work进程。注意master进程不会被关闭掉   kill -WINCH PID &#x2F;ki11 -WINCH&#96;cat &#x2F;usr&#x2F;<br><br/>local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid”</p>
</blockquote>
<h3 id="3-3-Nginx的命令行控制"><a href="#3-3-Nginx的命令行控制" class="headerlink" title="3.3.Nginx的命令行控制"></a>3.3.Nginx的命令行控制</h3><blockquote>
<p> -?,-h         : this help</p>
<p> -v            : show version and exit</p>
<p> -V            : show version and configure options then exit</p>
<p> -t            : test configuration and exit</p>
<ul>
<li>检测nginx.conf的语法</li>
</ul>
<p> -T            : test configuration, dump it and exit</p>
<ul>
<li>检测nginx.conf的语法，成功打印测试文件</li>
</ul>
<p> -q            : suppress non-error messages during configuration testing</p>
<p> -s signal     : send signal to a master process: stop, quit, reopen, reload</p>
<ul>
<li>stop 快速关闭</li>
<li>quit 等待关闭</li>
<li>reopen 类似USR1</li>
<li>reload 类似HUP</li>
</ul>
<p> -p prefix     : set prefix path (default: &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;)</p>
<ul>
<li>指定nginx的prefix路径</li>
</ul>
<p> -e filename   : set error log file (default: &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;error.log)</p>
<ul>
<li>设置日志路径</li>
</ul>
<p> -c filename   : set configuration file (default: &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf)</p>
<ul>
<li>设置配置文件路径</li>
</ul>
<p> -g directives : set global directives out of configuration file</p>
<ul>
<li>用来补充Nginx配置文件，向nginx服务指定启动时应用的全局的配置</li>
<li>.&#x2F;nginx -g “pid logs&#x2F;abc.pid;”</li>
</ul>
</blockquote>
<h3 id="3-4-版本升级"><a href="#3-4-版本升级" class="headerlink" title="3.4.版本升级"></a>3.4.版本升级</h3><h4 id="3-4-1使用nginx服务信号"><a href="#3-4-1使用nginx服务信号" class="headerlink" title="3.4.1使用nginx服务信号"></a>3.4.1使用nginx服务信号</h4><blockquote>
<p>cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin</p>
<p>mv nginx nginxold</p>
</blockquote>
<blockquote>
<p>cd ~&#x2F;nginx&#x2F;core&#x2F;nginx-1.16.1&#x2F;objs</p>
<p>cp nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin</p>
</blockquote>
<blockquote>
<p>查看nginx进程pid</p>
<p>ps -ef | grep nginx</p>
<p>平滑升级</p>
<p>kill -USR2 `cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&#96;</p>
<p>&#x2F;&#x2F;关闭旧进程</p>
<p>kill -QUIT `cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.oldbin&#96;</p>
</blockquote>
<h4 id="3-4-2使用make命令"><a href="#3-4-2使用make命令" class="headerlink" title="3.4.2使用make命令"></a>3.4.2使用make命令</h4><blockquote>
<p>cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin</p>
<p>mv nginx nginxold</p>
</blockquote>
<blockquote>
<p>cd ~&#x2F;nginx&#x2F;core&#x2F;nginx-1.16.1&#x2F;objs</p>
<p>cp nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin</p>
</blockquote>
<blockquote>
<p>进入安装目录，执行make upgrade</p>
</blockquote>
<blockquote>
<p>查看是否更新完成</p>
<p>.&#x2F;nginx -V</p>
</blockquote>
<h2 id="4-config配置目录"><a href="#4-config配置目录" class="headerlink" title="4.config配置目录"></a>4.config配置目录</h2><ul>
<li>全局块，events块，http块</li>
<li>http块中可以配置多个serve块，每个serve块又可以配置多个location块</li>
</ul>
<pre><code class="highlight plaintext">#user  nobody;
worker_processes  1;

events &#123;
    worker_connections  1024;
&#125;

http &#123;
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server &#123;
        listen       80;
        server_name  localhost;
        location / &#123;
            root   html;
            index  index.html index.htm;
        &#125;
        error_page   500 502 503 504  /50x.html;
        location = /50x.html &#123;
            root   html;
        &#125;
    &#125;
&#125;</code></pre>

<h3 id="4-1全局块"><a href="#4-1全局块" class="headerlink" title="4.1全局块"></a>4.1全局块</h3><h4 id="4-1-1user指令"><a href="#4-1-1user指令" class="headerlink" title="4.1.1user指令"></a>4.1.1user指令</h4><p>(1)user用于配置运行nginx服务器的worker进程的用户和用户组</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>user user [group]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>nobody</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<p>该属性也可以在编译时指定 .&#x2F;configure –user&#x3D;user –group&#x3D;group</p>
<blockquote>
<p>使用步骤</p>
<p>1.设置一个用户信息www,在nginx.conf设置，但是会报一个没有该用户的错误，此时需要useradd www</p>
<p>user www    测试.&#x2F;nginx -t</p>
</blockquote>
<pre><code class="highlight plaintext">[root@localhost sbin]# ./nginx -t
nginx: [emerg] getpwnam(&quot;www&quot;) 
failed in /usr/local/nginx/conf/nginx.conf:2

nginx: configuration file /usr/
local/nginx/conf/nginx.conf test failed</code></pre>

<blockquote>
<p>2.此时如果将html查询的目录改为 &#x2F;root&#x2F;html   –&gt;此时会403，权限不足</p>
<p>因此我们可以改为&#x2F;home&#x2F;www&#x2F;html此时便可以访问index.html页面</p>
</blockquote>
<blockquote>
<p>user指令可以指定启动运行工作进程的用户和用户组，这样对于系统的权限访问控制更加精细，也更加安全</p>
</blockquote>
<h4 id="4-1-2work-process指令"><a href="#4-1-2work-process指令" class="headerlink" title="4.1.2work_process指令"></a>4.1.2work_process指令</h4><blockquote>
<p>master_process指定是否开启工作进程</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>master_process on | off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>master_process on</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<blockquote>
<p>用于配置nginx生产工作进程的数量，建议将该值与服务器cpu的内核数保持一致</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>worker_processes num&#x2F;auto</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>1</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<blockquote>
<p>如果设置为2</p>
</blockquote>
<p><img src="https://p0.meituan.net/csc/1033797de3ad8db6e6891d84f665557b263926.png" alt="2024-08-06 162509.png"></p>
<h4 id="4-1-3其他指令"><a href="#4-1-3其他指令" class="headerlink" title="4.1.3其他指令"></a>4.1.3其他指令</h4><p>daemon:设定nginx是否以守护进程的方式启动</p>
<blockquote>
<p>守护进程是linux后台执行的一种服务进程，特点是独立于控制终端，不会随着终端的关闭而停止</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>daemon on&#x2F;off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>daemon on</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<p>pid:用来配置nginx当前master进程号ID存储的文件路径</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>pid file</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody></table>
<p>error log配置错误日志存放路径</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>error_log file [日志级别]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid</td>
</tr>
<tr>
<td>位置</td>
<td>全局块、http、serve、location</td>
</tr>
</tbody></table>
<p>日志级别：debug info notice warn error crit alert emerg  –&gt;建议不要使用info一下级别</p>
<p>include：用来引入其他配置文件，使nginx的配置更加灵活</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>include file</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>无</td>
</tr>
<tr>
<td>位置</td>
<td>any</td>
</tr>
</tbody></table>
<p>include main.conf   —&gt;可以将一部分配置写入main.conf文件中</p>
<h3 id="4-2events块"><a href="#4-2events块" class="headerlink" title="4.2events块"></a>4.2events块</h3><p>(1)accept_mutex用来设置nginx网络连接序列化</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>accept_mutex on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>accept_mutex on</td>
</tr>
<tr>
<td>位置</td>
<td>events</td>
</tr>
</tbody></table>
<blockquote>
<p>解决”惊群问题”</p>
</blockquote>
<p>(2)multi_accept:用来设置是否允许同时接受多个网络连接</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>multi_accept on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>multi_accept off</td>
</tr>
<tr>
<td>位置</td>
<td>events</td>
</tr>
</tbody></table>
<blockquote>
<p>建议开启on</p>
</blockquote>
<p>(3)worker connections:用来配置单个worker进程最大的连接数</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>worker_connections number</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>worker_connections 512</td>
</tr>
<tr>
<td>位置</td>
<td>events</td>
</tr>
</tbody></table>
<p>(4)use:用来设置nginx服务器选择哪种事件驱动来处理网络消息</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>use method</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>根据操作系统定</td>
</tr>
<tr>
<td>位置</td>
<td>events</td>
</tr>
</tbody></table>
<blockquote>
<p>method –&gt; select&#x2F;poll&#x2F;epoll&#x2F;kqueue</p>
<p>建议设置epoll</p>
</blockquote>
<h4 id="4-2-1指令配置实例"><a href="#4-2-1指令配置实例" class="headerlink" title="4.2.1指令配置实例"></a>4.2.1指令配置实例</h4><pre><code class="highlight plaintext">events&#123;
	accept_muyex on;
	multi_accpet on;
	worker_commections 1024;
	use epoll;
&#125;</code></pre>

<pre><code class="highlight plaintext">启动测试
./nginx -t
./nginx -s reload</code></pre>

<h3 id="4-3http块"><a href="#4-3http块" class="headerlink" title="4.3http块"></a>4.3http块</h3><p>(1)default_type:用来配置nginx响应前端请求默认的MIME类型</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>default_type mime-type</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>default_type text&#x2F;plain</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>(2)有些时候请求某些接口需要返回指定的文本字符串或者json字符串，如果逻辑非常简单或者干脆是固定的字符串，那么可以用nginx快速实现，减少服务器资源占用提升性能</p>
<p>(3)</p>
<p>access.log用来记录用户访问的请求</p>
<p>error.log记录nginx本身运行时的错误信息，不会记录用户的访问请求</p>
<p>(4)access_log用来设置用户访问日志的相关属性</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>access_log path[format[buffer&#x3D;size]]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>access_log logs&#x2F;access.log combined</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>(5)log_format:用来指定日志的输出格式</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>log_format name [escape&#x3D;default|json|none] string</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>log_format combined “…”</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody></table>
<blockquote>
<p>log_format myformat “&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;”;</p>
<p>access_log logs&#x2F;mylog.log myformat;</p>
</blockquote>
<p>(6)sendfile:设置是否用sendfile传输文件，可大大提升nginx处理静态资源的性能</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>sendfile on | off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>sendfile off</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody></table>
<p>(7)keepalive_timeout用来设置长连接的超时时间</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>keepalive_timeout time</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>keepalive_timeout 75s</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>(7)keepalive_requests用来设置keep-alive的次数</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>keepalive_requests number</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>keepalive_requests 100</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="4-4server和location块"><a href="#4-4server和location块" class="headerlink" title="4.4server和location块"></a>4.4server和location块</h3><pre><code class="highlight plaintext">server &#123;
    listen       80;
    server_name  localhost;
    location / &#123;
        root   html;
        index  index.html index.htm;
    &#125;
    error_page   500 502 503 504  /50x.html;
    location = /50x.html &#123;
        root   html;
    &#125;
&#125;</code></pre>

<h3 id="4-5基础配置实例"><a href="#4-5基础配置实例" class="headerlink" title="4.5基础配置实例"></a>4.5基础配置实例</h3><pre><code class="highlight plaintext">user  www;
worker_processes 2;
err_log logs/error.log;
pid logs/nginx.pid;

events &#123;
    accept_mutex on;
    multi_accept on;
    use epool;
    worker_connections  1024;
&#125;

http &#123;
    include       mime.types;
    default_type  application/octet-stream;
    log_format serve1 &#x27;======&gt;server1&#x27;;
    log_format serve2 &#x27;======&gt;server2&#x27;
    include /home/www/conf.d/*.conf;
 	sendfile        on;
    keepalive_timeout  65;

    server &#123;
        listen       80;
        server_name  localhost;
        location / &#123;
            root   html;
            index  index.html index.htm;
        &#125;
        error_page   500 502 503 504  /50x.html;
        location = /50x.html &#123;
            root   html;
        &#125;
&#125;</code></pre>

<h3 id="4-6nginx配置成系统服务"><a href="#4-6nginx配置成系统服务" class="headerlink" title="4.6nginx配置成系统服务"></a>4.6nginx配置成系统服务</h3><blockquote>
<p>(1)vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service</p>
</blockquote>
<pre><code class="highlight plaintext">[Unit]
Description=nginx web service
Documentation=http://nginx.org/en/docs
After=network.target

[Service]
Type=forking
PIDFile=/usr/local/nginx/logs/nginx.pid
ExecStartPre=/usr/local/nginx/sbin/nginx -t -c
/usr/local/nginx/conf/nginx.conf
ExecStart=/usr/local/nginx/sbin/nginx
ExexReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/usr/local/nginx/sbin/nginx -s stop
PrivateTmp=true

[Install]
wantedBy=defauly.target</code></pre>

<blockquote>
<p>（2）chmod 755 &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service</p>
</blockquote>
<blockquote>
<p>(3)使用系统命令操作</p>
<p>启动：systemctl start nginx</p>
<p>停止：systemctl stop nginx</p>
<p>重启：systemctl restart nginx</p>
<p>重新加载配置文件：systemctl reload nginx</p>
<p>查看nginx状态：systemctl status nginx</p>
<p>开机启动：systemctl enable nginx</p>
</blockquote>
<h3 id="4-7Nginx命令配置到系统环境"><a href="#4-7Nginx命令配置到系统环境" class="headerlink" title="4.7Nginx命令配置到系统环境"></a>4.7Nginx命令配置到系统环境</h3><blockquote>
<p>1.vim &#x2F;etc&#x2F;profile</p>
<p>export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin</p>
<p>2.source &#x2F;etc&#x2F;peofile</p>
</blockquote>
<h2 id="5-Nginx静态资源部署"><a href="#5-Nginx静态资源部署" class="headerlink" title="5.Nginx静态资源部署"></a>5.Nginx静态资源部署</h2><h3 id="5-11-listen"><a href="#5-11-listen" class="headerlink" title="5.11.listen"></a>5.11.listen</h3><table>
<thead>
<tr>
<th>语法</th>
<th>listen address[:port] [default_server]…</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>listen  *:80 | *:8000</td>
</tr>
<tr>
<td>位置</td>
<td>server</td>
</tr>
</tbody></table>
<p>default_server属性时标识符号，用来设置默认主机</p>
<pre><code class="highlight plaintext">server&#123;
	listen 8080 default_server
&#125;</code></pre>

<h3 id="5-22-server-name"><a href="#5-22-server-name" class="headerlink" title="5.22.server_name"></a>5.22.server_name</h3><blockquote>
<p>设置虚拟主机服务名称</p>
</blockquote>
<p>127.0.0.1 localhost 域名</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>server_name name…;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>server_name “”;</td>
</tr>
<tr>
<td>位置</td>
<td>server</td>
</tr>
</tbody></table>
<blockquote>
<p>精确匹配</p>
<p>通配符匹配</p>
<p>正则表达式匹配</p>
</blockquote>
<h4 id="5-2-1精确匹配"><a href="#5-2-1精确匹配" class="headerlink" title="5.2.1精确匹配"></a>5.2.1精确匹配</h4><pre><code class="highlight plaintext">server&#123;
	server_name www.nginx.org;
&#125;</code></pre>

<blockquote>
<p>hosts是一个没有扩展名的系统文件</p>
<p>Windows:C:\Windows\System32\drivers\etc</p>
<p>centos:&#x2F;etc&#x2F;hosts</p>
</blockquote>
<h4 id="5-2-2通配符匹配"><a href="#5-2-2通配符匹配" class="headerlink" title="5.2.2通配符匹配"></a>5.2.2通配符匹配</h4><blockquote>
<p>通配符可以出现在开头或结尾，但不能用在域名的中部</p>
</blockquote>
<pre><code class="highlight plaintext">server&#123;
	server_name *.richu.cn 
&#125;</code></pre>

<h4 id="5-2-3正则表达式匹配"><a href="#5-2-3正则表达式匹配" class="headerlink" title="5.2.3正则表达式匹配"></a>5.2.3正则表达式匹配</h4><p>1.正则表达式和分组</p>
<blockquote>
<p>由于Nginx配置文件中经常出现正则表达式，因此本章节专门对常见的正则表达式进行简单介绍。</p>
</blockquote>
<blockquote>
<p>[1] 开始与结束</p>
<p>^表示匹配输入字符串的开始   </p>
<p>$表示匹配输入字符串的结束</p>
</blockquote>
<blockquote>
<p>[2] 匹配次数</p>
<p>?表示匹配0次或者1次</p>
<p>+表示匹配1次或多次</p>
<p>*表示匹配0从或多次</p>
<p>{n}匹配n次，{n,}至少匹配n次，{n,m} 匹配n至m次</p>
</blockquote>
<blockquote>
<p>[3] 匹配字符</p>
<p>\符号用于转义</p>
<p>.匹配除\n之外的任意字符</p>
<p>[xyz]表示匹配xyz中任意一个字符</p>
<p>[a-z]表示匹配任意小写字母;[^a-z]取反，表示匹配除小写字母之外的任意字符;</p>
<p>[A-Z]表示匹配任意大写字母;[a-zA-Z]匹配任意字母;</p>
<p>[0-9]表示匹配任意数字, 等价于\d;  [^0-9]表示匹配任意数字, 等价于\D</p>
<p>\s匹配任何空白字符；\S匹配任何非空白字符;</p>
<p>\w A-Z a-z 0-9</p>
<p>x|y 表示匹配x或y</p>
</blockquote>
<blockquote>
<p>在前面加上~表示为正则表达式</p>
<p>server_name example.com ~^www\d+.example.com$</p>
</blockquote>
<blockquote>
<p>server_name ~^www\.(\w+)\.com</p>
<p>location &#x2F; {</p>
<p>​	return 200 $1 $2</p>
<p>}</p>
</blockquote>
<p><code>$1可以匹配到(\w+)中匹配的内容</code></p>
<h4 id="5-2-4匹配执行顺序"><a href="#5-2-4匹配执行顺序" class="headerlink" title="5.2.4匹配执行顺序"></a>5.2.4匹配执行顺序</h4><blockquote>
<p>精确匹配 —》 通配符在开始    —》 通配符在结尾    —》正则表达式   —》默认default_server;</p>
</blockquote>
<h3 id="5-3location"><a href="#5-3location" class="headerlink" title="5.3location"></a>5.3location</h3><blockquote>
<p>用来设置请求的url</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>location [ &#x3D; | ~ ~* ^- | @] uri{…}</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>server,location</td>
</tr>
</tbody></table>
<blockquote>
<p>&#x3D;用在不包含正则表达式的uri前面，必须与指定的内容精确匹配</p>
</blockquote>
<pre><code class="highlight plaintext">location =/abc &#123;
	
&#125;</code></pre>

<blockquote>
<p>~ 正则匹配，区分大小写</p>
<p>~*正则匹配，不区分大小写</p>
</blockquote>
<blockquote>
<p>^~用于不包含正则表达式的uri前面，功能与不加符号一致，唯一不同的是，如果模式匹配，那么就会停止搜索其他模式</p>
</blockquote>
<h3 id="5-4root-alias"><a href="#5-4root-alias" class="headerlink" title="5.4root&#x2F;alias"></a>5.4root&#x2F;alias</h3><blockquote>
<p>root:设置请求的根目录</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>root path</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>root html</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>alias：用来更改location的url</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>alias path</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>location</td>
</tr>
</tbody></table>
<blockquote>
<p>root：root路径加location后面的地址</p>
<p>alias：不会加上location后面的地址</p>
<ul>
<li>alias是目录别名的定义</li>
</ul>
</blockquote>
<h3 id="5-5index"><a href="#5-5index" class="headerlink" title="5.5index"></a>5.5index</h3><p>index  设置网站的默认首页 </p>
<table>
<thead>
<tr>
<th>语法</th>
<th>index file …</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>index index.html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>后面可以配置多个选项，当一个匹配之后就不会再匹配后面的设置</p>
</blockquote>
<h3 id="5-6error-page"><a href="#5-6error-page" class="headerlink" title="5.6error_page"></a>5.6error_page</h3><blockquote>
<p>设置网站的错误页面</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>index file …</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>index index.html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>(1)可以跳转指定页面</p>
<blockquote>
<p>error_page 404 <a target="_blank" rel="noopener" href="http://www.richu.cn/">www.richu.cn</a></p>
</blockquote>
<p>(2)重定向地址</p>
<blockquote>
<p>error _page 404 &#x2F;50x.html</p>
</blockquote>
<p>(3)使用location的@符号完成错误信息的匹配</p>
<pre><code class="highlight plaintext">server&#123;
	error_page 404 @jump_to_error;
	location @jump_to_error &#123;
		default_type text/plain;
		return 404 &#x27;Not Found Html&#x27;
	&#125;
&#125;</code></pre>

<p>(4)可选项&#x3D;[response]的作用是将相应的代码更改为另一个</p>
<blockquote>
<p>error_page 404 &#x3D;200 &#x2F;50x.html</p>
</blockquote>
<h2 id="6-静态资源优化配置语法"><a href="#6-静态资源优化配置语法" class="headerlink" title="6.静态资源优化配置语法"></a>6.静态资源优化配置语法</h2><h4 id="6-1-sendfile"><a href="#6-1-sendfile" class="headerlink" title="6.1.sendfile"></a>6.1.sendfile</h4><blockquote>
<p>用来开启高效的文件传输模式</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>sendfile on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>sendfile off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h4 id="6-2-tcp-nopush"><a href="#6-2-tcp-nopush" class="headerlink" title="6.2.tcp_nopush"></a>6.2.tcp_nopush</h4><blockquote>
<p>需要打开sendfile用来提升网络包传输效率</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>tcp_nopush on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>tcp_nopush off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h4 id="6-3-tcp-nodelay"><a href="#6-3-tcp-nodelay" class="headerlink" title="6.3.tcp_nodelay"></a>6.3.tcp_nodelay</h4><blockquote>
<p>需要打开keep-alive用来提升网络包传输的实时性</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>tcp_nodelay on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>tcp_nodelay on;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>sendfile on</p>
<p>tcp_nopush in</p>
<p>tcp_nodealy on</p>
</blockquote>
<h4 id="6-4-gizp"><a href="#6-4-gizp" class="headerlink" title="6.4.gizp"></a>6.4.gizp</h4><blockquote>
<p>开启或关闭gzip功能</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h4 id="6-5-gzip-types"><a href="#6-5-gzip-types" class="headerlink" title="6.5.gzip_types"></a>6.5.gzip_types</h4><table>
<thead>
<tr>
<th>语法</th>
<th>gzip_types mime-type</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_types text&#x2F;html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>根据响应页面的MIME类型选择性开启Gzip压缩功能</p>
</blockquote>
<blockquote>
<p>gzip_types *;</p>
</blockquote>
<h4 id="6-6-gzip-comp-level"><a href="#6-6-gzip-comp-level" class="headerlink" title="6.6.gzip_comp_level"></a>6.6.gzip_comp_level</h4><blockquote>
<p>设置压缩程度，1-9,1程度低，效率高，9程度高，效率低。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_comp_level level</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_comp_level 1;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h4 id="6-7-gzip-vary"><a href="#6-7-gzip-vary" class="headerlink" title="6.7.gzip_vary"></a>6.7.gzip_vary</h4><blockquote>
<p>告诉接收方，所发送的数据经过了gzip压缩处理</p>
<p>vary:Accrpt-Encoding</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_vary on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_vary off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h4 id="6-8-gzip-buffers"><a href="#6-8-gzip-buffers" class="headerlink" title="6.8.gzip_buffers"></a>6.8.gzip_buffers</h4><blockquote>
<p>处理请求压缩的缓冲区数量和大小</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_buffers number size</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_buffers 32 4k | 16 8k;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>number为Nginx服务器向系统申请缓存空间数量，size指的是每个缓冲空间的大小。</p>
<p>建议不用设置，使用默认值即可</p>
</blockquote>
<h4 id="6-9-gzip-disable"><a href="#6-9-gzip-disable" class="headerlink" title="6.9.gzip_disable"></a>6.9.gzip_disable</h4><blockquote>
<p>针对不同的客户端发起的请求，可以选择性开启和关闭Gzip</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_disable regex …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>regex根据user-agent来设置，支持正则表达式</p>
<blockquote>
<p>gzip_disable “MSIE [1-6]\.”;  禁用IE1-6版本的gzip</p>
</blockquote>
<h4 id="6-10-gzip-http-version"><a href="#6-10-gzip-http-version" class="headerlink" title="6.10.gzip_http_version:"></a>6.10.gzip_http_version:</h4><blockquote>
<p>针对不同的Http协议版本，可以选择性开启和关闭Gzip</p>
<p>建议使用默认值</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_http_version version 1.0|1.1</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_http_version 1.1</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h4 id="6-11-gzip-min-length"><a href="#6-11-gzip-min-length" class="headerlink" title="6.11.gzip_min_length"></a>6.11.gzip_min_length</h4><blockquote>
<p>针对传输数据的大小，可以选择性开启和关闭Gzip</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_min_length length</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_min_length 20</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>字节bytes 千字节kb 兆m</p>
</blockquote>
<h4 id="6-12-gzip-proxied"><a href="#6-12-gzip-proxied" class="headerlink" title="6.12.gzip_proxied"></a>6.12.gzip_proxied</h4><blockquote>
<p>设置是否对服务端返回的结果进行gzip压缩</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_proxied off|expired|no-cache<br> no store | private|no_last_modified|no_etag|auth|any</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_proxied off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">gzip on; 
gzip_types *;
gzip_comp_level 6;
gzip_min_length 1024;
gzip_buffers 4 1024;
gzip_http_version 1.1;
gzip_vary on;
gzip_disable &quot;MISE [1-6]\.&quot;;
gzip_proxied off;</code></pre>

<blockquote>
<p>vim nginx_gzip.conf</p>
</blockquote>
<h4 id="6-13-sendfile和Gzip的共存问题"><a href="#6-13-sendfile和Gzip的共存问题" class="headerlink" title="6.13.sendfile和Gzip的共存问题"></a>6.13.sendfile和Gzip的共存问题</h4><p>gzip_static</p>
<blockquote>
<p>检查与文件同名的.gz文件，response中以gzip相关的header返回.gz文件的内容</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_static on | off always</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_static off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>报错</p>
<p>nginx: [emerg] unknown directive “gzip_static” in &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf:33</p>
<p>nginx: configuration file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf test failed</p>
</blockquote>
<blockquote>
<p>添加模块到Nginx</p>
</blockquote>
<p>(1)查看配置参数</p>
<blockquote>
<p>nginx -V</p>
</blockquote>
<pre><code class="highlight plaintext">--prefix=/usr/local/nginx --sbin-path=/usr/local/nginx/sbin/
nginx --modules-path=/usr/local/nginx/modules --conf-path=/usr/
local/nginx/conf/nginx.conf --error-log-path=/usr/local/nginx/
logs/error.log --http-log-path=/usr/local/nginx/logs/access.log 
--pid-path=/usr/local/nginx/logs/nginx.pid --lock-path=/usr/local/
nginx/logs/nginx.lock</code></pre>

<p>(2)将nginx二进制目录改名</p>
<blockquote>
<p>mv nginx nginxold</p>
</blockquote>
<p>(3)make clean</p>
<p>(4)使用.&#x2F;configure 配置参数</p>
<pre><code class="highlight plaintext">./configure --prefix=/usr/local/nginx --sbin-path=/usr/local/nginx/
sbin/nginx --modules-path=/usr/local/nginx/modules --conf-path=/
usr/local/nginx/conf/nginx.conf --error-log-path=/usr/local/nginx/
logs/error.log --http-log-path=/usr/local/nginx/logs/access.log 
--pid-path=/usr/local/nginx/logs/nginx.pid --lock-path=/usr/local/
nginx/logs/nginx.lock --with-http_gzip_static_module</code></pre>

<p>(5)make</p>
<p>(6)</p>
<blockquote>
<p>cd objs</p>
<p>cp nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin</p>
</blockquote>
<p>(7)make upgrade</p>
<blockquote>
<p>使用测试</p>
<p>gzip promise.js</p>
</blockquote>
<pre><code class="highlight plaintext">#响应标头
accept-ranges:bytes
connection:keep-alive
content-encoding:gzip
content-length:1065
content-type:application/javascript
date:Sat, 10 Aug 2024 08:03:15 GMT
etag:&quot;66b71e2a-429&quot;
last-modified:Sat, 10 Aug 2024 08:00:42 GMT
server:nginx/1.26.1
vary:Accept-Encoding</code></pre>

<h2 id="7-静态资源的缓存处理"><a href="#7-静态资源的缓存处理" class="headerlink" title="7.静态资源的缓存处理"></a>7.静态资源的缓存处理</h2><blockquote>
<p>用来减少等待数据的时间</p>
</blockquote>
<blockquote>
<p>客户端缓存</p>
<ul>
<li>浏览器缓存</li>
</ul>
<p>服务端缓存</p>
<ul>
<li>nginx &#x2F;Redis &#x2F; Memcached等</li>
</ul>
</blockquote>
<h3 id="7-1浏览器缓存的执行流程"><a href="#7-1浏览器缓存的执行流程" class="headerlink" title="7.1浏览器缓存的执行流程"></a>7.1浏览器缓存的执行流程</h3><table>
<thead>
<tr>
<th>header</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Expires</td>
<td>缓存过期的日期和时间</td>
</tr>
<tr>
<td>Cache-Control</td>
<td>设置和缓存相关的配置信息</td>
</tr>
<tr>
<td>Last-Modified</td>
<td>设置请求资源的最后修改时间</td>
</tr>
<tr>
<td>ETag</td>
<td>请求变量的实体标签的当前值，比如文件的MD5值</td>
</tr>
</tbody></table>
<h3 id="7-2expires指令"><a href="#7-2expires指令" class="headerlink" title="7.2expires指令"></a>7.2expires指令</h3><blockquote>
<p>控制页面缓存</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>expires [modified] time<br> expires epoch |max  | off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>expires off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>time:可以是正数也可以是为负数，指定过期时间，负数则Cache-Control为no-cache，则Cache-control的值为max-age&#x3D;time</p>
<p>epoch：指定为1970年，Cache-control的值为no-cache</p>
<p>max：指定2037年，Cache-control的值为10年</p>
<p>off：默认不缓存</p>
<pre><code class="highlight plaintext">location ~ .*\.(html|js|css|png)$&#123;
	expires 1000;     //1000秒
&#125;</code></pre>

<h3 id="7-3add-header指令"><a href="#7-3add-header指令" class="headerlink" title="7.3add_header指令"></a>7.3add_header指令</h3><blockquote>
<p>添加指定的响应头和响应值</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>add_headername value [always]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">Cache-control: must-revalidate 可缓存但必须再向源服务器进行确认
Cache-control: no-cache     缓存前必须确认其有效性
Cache-control: no-store		不缓存请求或响应的任何内容
Cache-control: no-transform		代理不可更改媒体类型
Cache-control: public	可向任意方提供响应的缓存
Cache-control: private	仅向特定用户返回响应

#要求中间缓存服务器对缓存的响应有效性再次确认
Cache-control: proxy-revalidate		

Cache-Control: max-age=&lt;seconds&gt;

响应最大Age值
Cache-control: 

s-maxage=&lt;seconds&gt;	
公共缓存服务器响应的最大Age值</code></pre>

<h2 id="8-Nginx的跨域问题解决"><a href="#8-Nginx的跨域问题解决" class="headerlink" title="8.Nginx的跨域问题解决"></a>8.Nginx的跨域问题解决</h2><h3 id="8-1跨域问题"><a href="#8-1跨域问题" class="headerlink" title="8.1跨域问题"></a>8.1跨域问题</h3><blockquote>
<p>服务器的同源策略：浏览器最基本最核心的安全功能，如果浏览器少了同源协议，则浏览器的正常功能会收到影响</p>
<p>协议，域名，端口相同</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>add_headername value [always]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>Access-Control-Allow-origin   允许跨域访问的源地址信息 *</p>
<p>Access-Control-Allow-Methods	允许跨域请求的请求方式 GET POST</p>
</blockquote>
<pre><code class="highlight plaintext">location /get&#123;
	add_header Access-Control-Allow-Origin http:192.168.200.133;
	add_header Access-Control-Allow-Methods GET,POST,DELETE,PUT
&#125;</code></pre>

<h3 id="8-2静态资源防盗链"><a href="#8-2静态资源防盗链" class="headerlink" title="8.2静态资源防盗链"></a>8.2静态资源防盗链</h3><blockquote>
<p>HTTP头信息Referer,当浏览器向Web服务器发送请求的时候，一般都会带上Referer，来告诉浏览器是从哪个页面链接过来的</p>
</blockquote>
<p>valid_referers:nginx会通过查看referer自动和valid_referers后面的内容进行匹配，如果匹配到了将$invalid_referer变量置为0,如果没有匹配到，则将$invalid_referer变量置为1</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>valid_referers none | blobked | server_names | string</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>none 如果Header中的Referer为空，允许访问</p>
<p>blobked：在Header中的Referer不为空</p>
<p>server_names:指定域名和ip</p>
<p>string:支持正则表达式和带*的字符串</p>
</blockquote>
<h2 id="9-url重写-Rewrite"><a href="#9-url重写-Rewrite" class="headerlink" title="9.url重写(Rewrite)"></a>9.url重写(Rewrite)</h2><blockquote>
<p>Rewrite，依赖PCRE的支持</p>
<p>ngx_http_rewrite_module</p>
</blockquote>
<h3 id="9-1set"><a href="#9-1set" class="headerlink" title="9.1set"></a>9.1set</h3><table>
<thead>
<tr>
<th>语法</th>
<th>set $variable value</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">server &#123;
    listen 8080;
    server_name localhost;
    location /server&#123;
        //定义
        set $name &quot;test&quot;;
        set $age 18;
        default_type text/plain;
        //使用
        return 200 $name=$age;
    &#125;
&#125;</code></pre>

<pre><code class="highlight plaintext">$args

变量中存放了请求URL中的请求参数。
比如http://192.168.200.133/server?arg1=value1&amp;args2=value2中 
的&quot;arg1=value1&amp;arg2=value2&quot;，功能和$query_string一样。

$http_user_agent

变量存储的是用户访问服务的代理信息
(如果通过浏览器访问，记录的是浏览器的相关版本信息)

$host

变量存储的是访问服务器的server_name值

$document_uri

变量存储的是当前访问地址的URI。
比如http://192.168.200.133/server?i
d=10&amp;name=zhangsan中的&quot;/server&quot;，功能和$uri一样

$document_root

变量存储的是当前请求对应location的root值，
如果未设置，默认指向Nginx自带html目录所在位置

$content_length

变量存储的是请求头中的Content-Length的值

$content_type

变量存储的是请求头中的Content-Type的值

$http_cookie

变量存储的是客户端的cookie信息，
可以通过add_header Set-Cookie&#x27;cookieName=cookieValue&#x27;来添加cookie数据

$limit_rate

变量中存储的是Nginx服务器对网络连接速率的限制，
也就是Nginx配置中对limit_rate指令设置的值，默认是0，不限制。

$remote_addr

变量中存储的是客户端的IP地址

$remote_port

变量中存储了客户端与服务端建立连接的端口号

$remote_user

变量中存储了客户端的用户名，需要有认证模块才能获取

$scheme

变量中存储了访问协议

$server_addr

变量中存储了服务端的地址

$server_name

变量中存储了客户端请求到达的服务器的名称

$server_port

变量中存储了客户端请求到达服务器的端口号

$server_protocol

变量中存储了客户端请求协议的版本，比如&quot;HTTP/1.1&quot;

$request_body_file

变量中存储了发给后端服务器的本地文件资源的名称

$request_method

变量中存储了客户端的请求方式，比如&quot;GET&quot;,&quot;POST&quot;等

$request_filename

变量中存储了当前请求的资源文件的路径名

$request_uri

变量中存储了当前请求的URI，并且携带请求参数，
比如http://192.168.200.133/server?id=10&amp;name=zhangsan中的&quot;/server?</code></pre>

<pre><code class="highlight plaintext"> log_format main 
 &#x27;$remote_addr-$request - $status 
 - $request_uri - $http_user_agent&#x27;;

    server &#123;
        listen 8080;
        server_name localhost;
        location /server&#123;
            set $name &quot;test&quot;;
            set $age 18;
            default_type text/plain;
            return 200 $name=$age;
        &#125;


192.168.3.1 - - [11/Aug/2024:02:53:25 -0400] &quot;GET /server 
HTTP/1.1&quot; 200 7 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) 
AppleWebKit/537.36 (KHTML, like 
Gecko) Chrome/127.0.0.0 Safari/537.36&quot;</code></pre>

<h3 id="9-2if指令"><a href="#9-2if指令" class="headerlink" title="9.2if指令"></a>9.2if指令</h3><blockquote>
<p>条件判断</p>
<p>if (){</p>
<p>}</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>if (condition)</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>server、locatio</td>
</tr>
</tbody></table>
<p>空字符串和0为false，其他都为true</p>
<blockquote>
<p>使用&#x3D;和！&#x3D;来比较字符串是否相等</p>
<p>字符串不需要添加引号</p>
<p>~正则匹配   ~*不区分大小写</p>
</blockquote>
<pre><code class="highlight plaintext">if ($http_user_agent ~ MSIE)&#123;
		#$http_user_agent是否包含MISE，如果包含返回true
&#125;

-f指定文件是否存在
if (!-f $request_file)&#123;

&#125;</code></pre>

<blockquote>
<p>目录-d</p>
<p>请求的目录或文件-e</p>
<p>是否可执行-x</p>
</blockquote>
<h3 id="9-3break指令"><a href="#9-3break指令" class="headerlink" title="9.3break指令"></a>9.3break指令</h3><table>
<thead>
<tr>
<th>语法</th>
<th>break</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>server、locatio</td>
</tr>
</tbody></table>
<blockquote>
<p>终止此次操作并重定向操作</p>
</blockquote>
<h3 id="9-4return"><a href="#9-4return" class="headerlink" title="9.4return"></a>9.4return</h3><blockquote>
<p>用于完成对请求的处理，直接向客户端返回，return后所有的nginx配置都是无效的</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>return code [text]<br/> return code URL <br/> return html</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>server、locatio、if</td>
</tr>
</tbody></table>
<h3 id="9-5rewrite"><a href="#9-5rewrite" class="headerlink" title="9.5rewrite"></a>9.5rewrite</h3><table>
<thead>
<tr>
<th>语法</th>
<th>rewrite regex replacement [flag]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>server、locatio、if</td>
</tr>
</tbody></table>
<blockquote>
<p>regex:用来匹配URI的正则表达式</p>
<p>匹配成功后，用于替换URI的内容，如果是http或https开头则不会继续向下匹配</p>
</blockquote>
<pre><code class="highlight plaintext">location /rewrite&#123;
	rewrite ^/rewrite/(test)\w*$ /$1;
&#125;

//访问http://ip/rewrite/testabc         -------&gt;    /test</code></pre>

<p>flag:用来设置rewrite对uri的处理行为，可选值如下</p>
<ul>
<li>last:作为一个新的uri，可以使用其他的location块进行处理</li>
</ul>
<pre><code class="highlight plaintext">location /rewrite&#123;
	rewrite ^/rewrite/(test)\w*$ /$1 last;
&#125;</code></pre>

<ul>
<li>break:作为一个新的uri，将重写的uri在本location中继续处理，不会将新的uri转向其他的location块</li>
</ul>
<pre><code class="highlight plaintext">location /rewrite&#123;
	rewrite ^/rewrite/(test)\w*$ /$1 break;
&#125;</code></pre>

<ul>
<li>redirect:指明为重定向，状态码为302</li>
</ul>
<pre><code class="highlight plaintext">location /rewrite&#123;
	rewrite ^/rewrite/(test)\w*$ /$1 redirect;
&#125;</code></pre>

<ul>
<li>permanent:状态码为301，指明为永久重定向</li>
</ul>
<pre><code class="highlight plaintext">location /rewrite&#123;
	rewrite ^/rewrite/(test)\w*$ /$1 permanent;
&#125;</code></pre>

<h3 id="9-6rewrite-log"><a href="#9-6rewrite-log" class="headerlink" title="9.6rewrite_log"></a>9.6rewrite_log</h3><p>该指令配置是否开启URL重写日志的输出功能</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>rewrite_log regex on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、locatio、if</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">rewrite_log on;
err_log logs_error.log notice;</code></pre>

<h3 id="9-7域名镜像"><a href="#9-7域名镜像" class="headerlink" title="9.7域名镜像"></a>9.7域名镜像</h3><blockquote>
<p>指将相同的网站分别放置在不同的服务器上，并分别使用单独的URL进行访问，其中一台为主站，其余为镜像网站</p>
</blockquote>
<blockquote>
<p>server_name_in_redirect on | off</p>
<p>如果为on   重定向为 <a target="_blank" rel="noopener" href="http://server_name:8082/%E7%9B%AE%E5%BD%95%E5%90%8D/">http://server_name:8082/目录名/</a>;</p>
<p>如果为off  重定向为 http:&#x2F;&#x2F;原URL的ip地址:8082&#x2F;目录名&#x2F;;</p>
</blockquote>
<h3 id="9-8目录合并"><a href="#9-8目录合并" class="headerlink" title="9.8目录合并"></a>9.8目录合并</h3><blockquote>
<p>搜索引擎优化（SEO）是一种利用搜索引擎的搜索规则来提高目的网站在有关搜索引擎内排名的方式</p>
<p>如果目录层级有5层</p>
<p><a target="_blank" rel="noopener" href="http://www.web.name/server/11/22/33/44/20.html">http://www.web.name/server/11/22/33/44/20.html</a></p>
</blockquote>
<pre><code class="highlight plaintext">location &#123;
	rewrite ^/server-([0-9]+)-([0-9]+)-([0-9]+)-([0-9]+)/
        ([0-9])\.html$ /server/$1/$2/$3/$4/$5.html
&#125;</code></pre>

<h2 id="10-Nginx代理"><a href="#10-Nginx代理" class="headerlink" title="10.Nginx代理"></a>10.Nginx代理</h2><h3 id="10-1-正向代理"><a href="#10-1-正向代理" class="headerlink" title="10.1.正向代理"></a>10.1.正向代理</h3><pre><code class="highlight plaintext">location&#123;
	listen 82;
	location / &#123;
		resolver #设置DNS的IP 用来解析proxy_pass中的域名
		proxy_pass http://$host$request_uri;
	&#125;
&#125;</code></pre>

<blockquote>
<p>在客户端配置代理服务器</p>
</blockquote>
<p><img src="https://p0.meituan.net/csc/d5ae9133b01ea6b8e30ed34d1e9eeb38115244.png" alt="203832.png"></p>
<h3 id="10-2反向代理"><a href="#10-2反向代理" class="headerlink" title="10.2反向代理"></a>10.2反向代理</h3><h4 id="10-2-1proxy-pass-URL"><a href="#10-2-1proxy-pass-URL" class="headerlink" title="10.2.1proxy_pass URL"></a>10.2.1proxy_pass URL</h4><table>
<thead>
<tr>
<th>语法</th>
<th>proxy_pass  URL</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—-</td>
</tr>
<tr>
<td>位置</td>
<td>locatio</td>
</tr>
</tbody></table>
<p>URL为设置的被代理的服务器地址</p>
<blockquote>
<p> proxy_pass <a target="_blank" rel="noopener" href="http://192.168.133.3/getid">http://192.168.133.3/getid</a></p>
</blockquote>
<pre><code class="highlight plaintext">proxy_pass http://192.168.200.146/
proxy_pass http://192.168.200.146

# 当后面没有加上/则会吧location的请求路径拼上去，加上则不会</code></pre>

<h4 id="10-2-2peoxy-set-header"><a href="#10-2-2peoxy-set-header" class="headerlink" title="10.2.2peoxy_set_header"></a>10.2.2peoxy_set_header</h4><blockquote>
<p>更改请求头信息，然后将新的请求头信息发送到代理服务器</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_set_header field value;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_set_header Host $proxy_host<br/> proxy_set_header Connecting close;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、locatio</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">location / &#123;
	proxy_pass http://192.168.200.146:8080/;
	proxy_set_header username TOM;    #使用  $http_username
&#125;</code></pre>

<h4 id="10-2-3proxy-redirect"><a href="#10-2-3proxy-redirect" class="headerlink" title="10.2.3proxy_redirect"></a>10.2.3proxy_redirect</h4><blockquote>
<p>重置Location和Refresh的值</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_redirect redirect replacement;<br> proxy_redirect default;<br> proxy_redirect off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_redirect default</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、locatio</td>
</tr>
</tbody></table>
<blockquote>
<p>proxy_redirect <a target="_blank" rel="noopener" href="http://192.168.200.146/">http://192.168.200.146/</a> <a target="_blank" rel="noopener" href="http://192.168.200.133/">http://192.168.200.133/</a></p>
</blockquote>
<blockquote>
<p>proxy_redirect redirect replacement;</p>
<p>redirect 目标Location的值</p>
<p>replacement：需要替换的值</p>
</blockquote>
<blockquote>
<p>proxy_redirect default</p>
<p>将location的uri变量作为replacement</p>
<p>将proxy_pass变量作为redirect进行替换</p>
</blockquote>
<blockquote>
<p>proxy_redirect off</p>
<p>关闭proxy_redirect的功能</p>
</blockquote>
<h3 id="10-3安全控制"><a href="#10-3安全控制" class="headerlink" title="10.3安全控制"></a>10.3安全控制</h3><blockquote>
<p>安全隔离：通过代理分开客户端到服务端的连接。在方向道理之前设置防火墙，仅留一个入口供代理服务器访问</p>
</blockquote>
<h4 id="10-3-1对流量进行加密"><a href="#10-3-1对流量进行加密" class="headerlink" title="10.3.1对流量进行加密"></a>10.3.1对流量进行加密</h4><blockquote>
<p>http转换为https协议</p>
<p>SSL安全套接层</p>
<p>TLS传输层安全</p>
</blockquote>
<blockquote>
<p>http是明文传输数据，有安全问题，https是加密传输，相当于http+ssl，可以防止流量被劫持</p>
</blockquote>
<h4 id="10-3-2添加SSL支持"><a href="#10-3-2添加SSL支持" class="headerlink" title="10.3.2添加SSL支持"></a>10.3.2添加SSL支持</h4><blockquote>
<p>复制nginx二进制文件</p>
</blockquote>
<pre><code class="highlight plaintext">参数
--prefix=/usr/local/nginx --sbin-path=/usr/local/nginx/sbin/
nginx --modules-path=/usr/local/nginx/modules --conf-path=/usr/
local/nginx/conf/nginx.conf --error-log-path=/usr/local/nginx/
logs/error.log --http-log-path=/usr/local/nginx/logs/access.log 
--pid-path=/usr/local/nginx/logs/nginx.pid --lock-path=/usr/local/
nginx/logs/nginx.lock --with-http_gzip_static_module</code></pre>

<blockquote>
<p>.&#x2F;configure –with-http_ssl_modules</p>
<p>make</p>
<p>将obj下的</p>
<p>make upgrade</p>
</blockquote>
<h4 id="10-3-3ssl"><a href="#10-3-3ssl" class="headerlink" title="10.3.3ssl"></a>10.3.3ssl</h4><table>
<thead>
<tr>
<th>语法</th>
<th>ssl on| off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl off</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">server&#123;
	listen 443 ssl
&#125;</code></pre>

<h4 id="10-3-4ssl-certificate"><a href="#10-3-4ssl-certificate" class="headerlink" title="10.3.4ssl_certificate"></a>10.3.4ssl_certificate</h4><blockquote>
<p>指定PEM格式的证书</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_certificate file</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>——</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<h4 id="10-3-5ssl-session-cache"><a href="#10-3-5ssl-session-cache" class="headerlink" title="10.3.5ssl_session_cache"></a>10.3.5ssl_session_cache</h4><blockquote>
<p>配置ssl回话的缓存</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_session_cache off|none [builtin[:size]][shared:name:size]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_session_cache  none;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<blockquote>
<p>off:禁用缓存</p>
<p>none:禁用回话缓存</p>
<p>builtin:内置OpenSSL缓存，仅在一个工作进程中使用</p>
<p>shared:所有工作进程之间共享缓存，缓存相关的信息用name和size来指定</p>
</blockquote>
<h4 id="10-3-6ssl-session-timeout"><a href="#10-3-6ssl-session-timeout" class="headerlink" title="10.3.6ssl_session_timeout"></a>10.3.6ssl_session_timeout</h4><blockquote>
<p>开启回话后，设置客户端能够反复使用存储在缓存中的回话参数时间</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_session_timeout time</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_session_timeout 5m  &#x2F;&#x2F;5分钟</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<h4 id="10-2-7ssl-ciphers"><a href="#10-2-7ssl-ciphers" class="headerlink" title="10.2.7ssl_ciphers"></a>10.2.7ssl_ciphers</h4><blockquote>
<p>指出允许的密码，为openSSL支持的格式</p>
<p>openssl ciphers</p>
</blockquote>
<pre><code class="highlight plaintext">TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SH
A256:TLS_AES_128_CCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AE
S256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1
305:ECDHE-ECDSA-AES256-CCM:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES
128-GCM-SHA256:ECDHE-ECDSA-AES128-CCM:ECDHE-ECDSA-AES128-SHA256:ECDHE-
RSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:ECDHE-EC
DSA-AES128-SHA:ECDHE-RSA-AES128-SHA:AES256-GCM-SHA384:AES256-CCM:AES12
8-GCM-SHA256:AES128-CCM:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-
SHA:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256
-CCM:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-CCM:DHE-RSA-AES256-SHA25
6:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:PSK-AES2
56-GCM-SHA384:PSK-CHACHA20-POLY1305:PSK-AES256-CCM:PSK-AES128-GCM-SHA2
56:PSK-AES128-CCM:PSK-AES256-CBC-SHA:PSK-AES128-CBC-SHA256:PSK-AES128-
CBC-SHA:DHE-PSK-AES256-GCM-SHA384:DHE-PSK-CHACHA20-POLY1305:DHE-PSK-AE
S256-CCM:DHE-PSK-AES128-GCM-SHA256:DHE-PSK-AES128-CCM:DHE-PSK-AES256-C
BC-SHA:DHE-PSK-AES128-CBC-SHA256:DHE-PSK-AES128-CBC-SHA:ECDHE-PSK-CHAC
HA20-POLY1305:ECDHE-PSK-AES256-CBC-SHA:ECDHE-PSK-AES128-CBC-SHA256:ECD
HE-PSK-AES128-CBC-SHA</code></pre>

<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_ciphers ciphers</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_ciphers HIGH:!aNULL:!MD5</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<h4 id="10-2-8ssl-perfer-server-ciphers-on-off"><a href="#10-2-8ssl-perfer-server-ciphers-on-off" class="headerlink" title="10.2.8ssl_perfer_server_ciphers on|off"></a>10.2.8ssl_perfer_server_ciphers on|off</h4><table>
<thead>
<tr>
<th>语法</th>
<th>ssl_perfer_server_ciphers on</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_perfer_server_ciphers off</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<h3 id="10-4生成证书"><a href="#10-4生成证书" class="headerlink" title="10.4生成证书"></a>10.4生成证书</h3><blockquote>
<p>购买域名，购买SSL证书</p>
</blockquote>
<blockquote>
<p>openssl</p>
<p>确认系统是否安装openssl</p>
<p>openssl version</p>
</blockquote>
<blockquote>
<p>使用命令安装</p>
</blockquote>
<pre><code class="highlight plaintext">mkdir /root/cert

openssl genrsa -des3 -out server.key 1024

openssl req -new -key server.key -out server.csr

cp server.key server.key.org

openssl rsa -in server.key.org -out server.key

openssl x509 -req -days 365 -in server.csr -signkey server.key 
-out server.crt</code></pre>

<h3 id="10-5配置"><a href="#10-5配置" class="headerlink" title="10.5配置"></a>10.5配置</h3><pre><code class="highlight plaintext">server &#123;
        listen       443 ssl;
        server_name  localhost;

        ssl_certificate      cert.pem;
        ssl_certificate_key  cert.key;

        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;

        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

        location / &#123;
            root   html;
            index  index.html index.htm;
        &#125;
    &#125;</code></pre>

<pre><code class="highlight plaintext"> #报错
 SSL_CTX_use_certificate(&quot;/root/
 cert/server.crt&quot;) failed (SSL: 
 error:140AB18F:SSL 
 routines:SSL_CTX_use_certificate:e
 e key too small)

nginx: configuration file /usr/
local/nginx/conf/nginx.conf test failed</code></pre>

<blockquote>
<p>将大小改为2048</p>
</blockquote>
<pre><code class="highlight plaintext">mkdir /root/cert

openssl genrsa -des3 -out server.key 2048

openssl req -new -key server.key -out server.csr

cp server.key server.key.org

openssl rsa -in server.key.org -out server.key

openssl x509 -req -days 365 -in server.csr -signkey server.key 
-out server.crt</code></pre>
<p><img src="https://p1.meituan.net/csc/74f5448d9700c555edca4fe39e40684284784.png" alt="125312.png"></p>
<h3 id="10-6方向代理的优化"><a href="#10-6方向代理的优化" class="headerlink" title="10.6方向代理的优化"></a>10.6方向代理的优化</h3><h4 id="10-6-1proxy-buffering"><a href="#10-6-1proxy-buffering" class="headerlink" title="10.6.1proxy_buffering"></a>10.6.1proxy_buffering</h4><blockquote>
<p>开启关闭代理服务器的缓冲区</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffering on | off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffering on</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h4 id="10-6-2proxy-buffers"><a href="#10-6-2proxy-buffers" class="headerlink" title="10.6.2proxy_buffers"></a>10.6.2proxy_buffers</h4><blockquote>
<p>单个连接读取响应的缓存区个数和大小</p>
<p>number个数</p>
<p>size大小</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffers number size</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffers 8 4k</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>10.6.3proxy_buffer_size</p>
<blockquote>
<p>被代理服务器获取的第一部分响应数据的大小</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffer_size size</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffer_size 8k</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h5 id="10-6-4proxy-temp-path"><a href="#10-6-4proxy-temp-path" class="headerlink" title="10.6.4proxy_temp_path"></a>10.6.4proxy_temp_path</h5><blockquote>
<p>当缓存区满之后，会被临时存放在磁盘中，设置文件路径</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_temp_path path</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_temp_path proxy_temp</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h5 id="10-6-5proxy-temp-file-write-size"><a href="#10-6-5proxy-temp-file-write-size" class="headerlink" title="10.6.5proxy_temp_file_write size"></a>10.6.5proxy_temp_file_write size</h5><blockquote>
<p>设置磁盘缓存文件的大小</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_temp_file_write size</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_temp_file_write 8k</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h2 id="11-负载均衡"><a href="#11-负载均衡" class="headerlink" title="11.负载均衡"></a>11.负载均衡</h2><blockquote>
<p>将请求分配给不同的服务器中</p>
<p>横向扩展：提升单机的硬件</p>
<p>纵向扩展：提升服务器数量</p>
</blockquote>
<h3 id="11-1处理方式"><a href="#11-1处理方式" class="headerlink" title="11.1处理方式"></a>11.1处理方式</h3><blockquote>
<p>用户手动选择，提供不同线路、不同服务器的链接</p>
</blockquote>
<h3 id="11-2四-七层负载均衡"><a href="#11-2四-七层负载均衡" class="headerlink" title="11.2四&#x2F;七层负载均衡"></a>11.2四&#x2F;七层负载均衡</h3><blockquote>
<p>OSI,开放式系统互联模型</p>
<p>四层负载均衡为传输层，基于IP+PORT的负载均衡</p>
</blockquote>
<blockquote>
<p>七层负载均衡指的是应用层，主要是基于虚拟的URL或主机IP的负载均衡</p>
<p>四层负载均衡不识别域名，七层负载均衡识别域名</p>
<p>实际使用模式</p>
<p>四层（LVS）+七层（Nginx）</p>
</blockquote>
<h3 id="11-3Nginx七层负载均衡"><a href="#11-3Nginx七层负载均衡" class="headerlink" title="11.3Nginx七层负载均衡"></a>11.3Nginx七层负载均衡</h3><h4 id="11-3-1upstream"><a href="#11-3-1upstream" class="headerlink" title="11.3.1upstream"></a>11.3.1upstream</h4><blockquote>
<p>定义一组服务器，监听不同端口的服务器</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>upstream name {}</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>——</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody></table>
<h4 id="11-3-2server"><a href="#11-3-2server" class="headerlink" title="11.3.2server"></a>11.3.2server</h4><blockquote>
<p>指定后端服务器的名称和一些参数，可以使用域名、IP、端口或者unix-socket</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>server name [paramerters]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>——</td>
</tr>
<tr>
<td>位置</td>
<td>upstream</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">upstream 服务名&#123;
	server http://192.168.3.133:8080;
	server http://192.168.3.133:8081;
&#125;

http://服务名   //访问</code></pre>

<table>
<thead>
<tr>
<th>状态</th>
<th>概述</th>
</tr>
</thead>
<tbody><tr>
<td>down</td>
<td>当前server暂时不参与负载均衡</td>
</tr>
<tr>
<td>backup</td>
<td>标记为备份服务器，当主服务器不可用是，将用来传递请求</td>
</tr>
<tr>
<td>max_conns</td>
<td>设置代理服务器同时活动链接的最大数量，默认为0</td>
</tr>
<tr>
<td>max_fails</td>
<td>允许请求代理服务器失败的次数，默认1</td>
</tr>
<tr>
<td>fail_timeout</td>
<td>max_fails后，服务暂停的时间，默认10s</td>
</tr>
</tbody></table>
<h4 id="11-3-3down"><a href="#11-3-3down" class="headerlink" title="11.3.3down"></a>11.3.3down</h4><pre><code class="highlight plaintext">upstream 服务名&#123;
	server http://192.168.3.133:8080 down;
	server http://192.168.3.133:8081;
&#125;</code></pre>

<h3 id="11-4负载均衡策略"><a href="#11-4负载均衡策略" class="headerlink" title="11.4负载均衡策略"></a>11.4负载均衡策略</h3><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>轮询</td>
<td>默认</td>
</tr>
<tr>
<td>weight</td>
<td>权重，默认1，权重越高，被分配的请求越多</td>
</tr>
<tr>
<td>ip_hash</td>
<td>依据ip分配，每个访客可以固定访问一个后端服务</td>
</tr>
<tr>
<td>least_conn</td>
<td>依据最少连接方式，把请求优先分配给连接数少的后端服务器</td>
</tr>
<tr>
<td>url_hash</td>
<td>依据url分配方式，这样相同的url会被分配到同一个后端服务</td>
</tr>
<tr>
<td>fair</td>
<td>依据响应时间方式，响应时间短的服务将被优先分配</td>
</tr>
</tbody></table>
<h4 id="11-4-1轮询"><a href="#11-4-1轮询" class="headerlink" title="11.4.1轮询"></a>11.4.1轮询</h4><blockquote>
<p>轮询不需要做任何配置</p>
<p>按请求时间逐个分配到不同的后端服务器</p>
</blockquote>
<h4 id="11-4-2加权轮询"><a href="#11-4-2加权轮询" class="headerlink" title="11.4.2加权轮询"></a>11.4.2加权轮询</h4><blockquote>
<p>weight&#x3D;number 默认为1，权重越大，被分配请求的概率越大</p>
</blockquote>
<pre><code class="highlight plaintext">upstream webservers&#123;
    server 192.168.100.128:8080 weight=90 ;
    server 192.168.100.129:8080 weight=10 ;
&#125;</code></pre>

<h4 id="11-4-3ip-hash"><a href="#11-4-3ip-hash" class="headerlink" title="11.4.3ip_hash"></a>11.4.3ip_hash</h4><table>
<thead>
<tr>
<th>语法</th>
<th>ip_hash;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>——</td>
</tr>
<tr>
<td>位置</td>
<td>upstream</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">upstream webservers&#123;
	ip_hash;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
&#125;</code></pre>

<h4 id="11-4-4least-conn"><a href="#11-4-4least-conn" class="headerlink" title="11.4.4least_conn"></a>11.4.4least_conn</h4><pre><code class="highlight plaintext">upstream webservers&#123;
	least_conn;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
&#125;</code></pre>

<h4 id="11-4-5url-hash"><a href="#11-4-5url-hash" class="headerlink" title="11.4.5url_hash"></a>11.4.5url_hash</h4><blockquote>
<p>同一个url会到达同一个服务器</p>
</blockquote>
<pre><code class="highlight plaintext">upstream webservers&#123;
	hash $request_uri
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
&#125;</code></pre>

<h4 id="11-4-6fair"><a href="#11-4-6fair" class="headerlink" title="11.4.6fair"></a>11.4.6fair</h4><blockquote>
<p>下载nginx-upstream-fair</p>
<p><a target="_blank" rel="noopener" href="https://github.com/gnosek/nginx-upstream-fair">gnosek&#x2F;nginx-upstream-fair: The fair load balancer module for nginx (github.com)</a></p>
<p>&#x2F;root&#x2F;nginx&#x2F;module&#x2F;fair    解压并放入</p>
</blockquote>
<pre><code class="highlight plaintext">./configure --prefix=/usr/local/nginx --sbin-path=/usr/local/nginx/
sbin/nginx --modules-path=/usr/local/nginx/modules --conf-path=/
usr/local/nginx/conf/nginx.conf --error-log-path=/usr/local/nginx/
logs/error.log --http-log-path=/usr/local/nginx/logs/access.log 
--pid-path=/usr/local/nginx/logs/nginx.pid --lock-path=/usr/local/
nginx/logs/nginx.lock --with-http_gzip_static_module 
--with-http_ssl_module --add-module=/root/nginx/module/fair</code></pre>

<blockquote>
<p>make</p>
</blockquote>
<pre><code class="highlight plaintext">/root/nginx/module/fair/ngx_http_upstream_fair_module.c: 
在函数‘ngx_http_upstream_init_fair_rr’中:
/root/nginx/module/fair/ngx_http_upstream_fair_module.c:543:28: 
错误：‘ngx_http_upstream_srv_conf_t’ &#123;
    或称 ‘struct ngx_http_upstream_srv_conf_s’&#125;
    没有名为‘default_port’的成员
     if (us-&gt;port == 0 &amp;&amp; us-&gt;default_port == 0) &#123;
                            ^~
/root/nginx/module/fair/ngx_http_upstream_fair_module.c:553:51: 
错误：‘ngx_http_upstream_srv_conf_t’ &#123;
    或称 ‘struct ngx_http_upstream_srv_conf_s’&#125;
    没有名为‘default_port’的成员
     u.port = (in_port_t) (us-&gt;port ? us-&gt;port : us-&gt;default_port);
                                                   ^~
make[1]: *** 
[objs/Makefile:1254：objs/addon/fair/ngx_http_upstream_fair_module.o] 错误 1
make[1]: 离开目录“/root/nginx/core/nginx-1.26.1”

make: *** [Makefile:10：build] 错误 2
</code></pre>

<blockquote>
<p>报错解决方案</p>
<p>cd nginx目录&#x2F;src&#x2F;http</p>
<p>vim ngx_http_upstream.h</p>
</blockquote>
<pre><code class="highlight plaintext">struct ngx_http_upstream_srv_conf_s &#123;
    ngx_http_upstream_peer_t         peer;
    void                           **srv_conf;

    ngx_array_t                     
    *servers;  /* ngx_http_upstream_server_t */

    ngx_uint_t                       flags;
    ngx_str_t                        host;
    u_char                          *file_name;
    ngx_uint_t                       line;
    in_port_t                        port;
    in_port_t                        default_port;
    ngx_uint_t     no_port;  /* unsigned no_port:1 */

#if (NGX_HTTP_UPSTREAM_ZONE)
    ngx_shm_zone_t                  *shm_zone;
#endif
&#125;;</code></pre>

<blockquote>
<p>make</p>
</blockquote>
<pre><code class="highlight plaintext">upstream webservers&#123;
	fair;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
&#125;</code></pre>

<h3 id="11-5四层负载均衡"><a href="#11-5四层负载均衡" class="headerlink" title="11.5四层负载均衡"></a>11.5四层负载均衡</h3><blockquote>
<p>添加模块</p>
</blockquote>
<pre><code class="highlight plaintext">--prefix=/usr/local/nginx --sbin-path=/usr/local/nginx/sbin/
nginx --modules-path=/usr/local/nginx/modules --conf-path=/usr/
local/nginx/conf/nginx.conf --error-log-path=/usr/local/nginx/
logs/error.log --http-log-path=/usr/local/nginx/logs/access.log 
--pid-path=/usr/local/nginx/logs/nginx.pid --lock-path=/usr/local/
nginx/logs/nginx.lock --with-http_gzip_static_module 
--with-http_ssl_module --add-module=/root/nginx/module/
fair --with-stream</code></pre>

<h4 id="11-5-1stream指令"><a href="#11-5-1stream指令" class="headerlink" title="11.5.1stream指令"></a>11.5.1stream指令</h4><blockquote>
<p>和http同级，指定服务器指令的配置文件上下文</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>stream；</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>——</td>
</tr>
<tr>
<td>位置</td>
<td>main</td>
</tr>
</tbody></table>
<h3 id="11-6redis"><a href="#11-6redis" class="headerlink" title="11.6redis"></a>11.6redis</h3><p><a target="_blank" rel="noopener" href="https://redis.io/downloads/#redis-downloads">https://redis.io/downloads/#redis-downloads</a></p>
<blockquote>
<p>tar -zxf redis.tar.gz</p>
<p>make PREFIX&#x3D;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis01 install</p>
<p>cd &#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis01</p>
<p>vim redis.conf</p>
<ul>
<li>port 6379</li>
<li>daemonize yes</li>
</ul>
</blockquote>
<blockquote>
<p>启动</p>
<p>.&#x2F;redis-server ..&#x2F;redis.conf</p>
<p>bind 0.0.0.0  允许其他主机访问</p>
<p>redis-cli -h 192.168.3.133 -p 6379</p>
</blockquote>
<pre><code class="highlight plaintext">stream&#123;
	upstream redisbackend&#123;
		server 192.168.3.133:6379;
		server 192.168.3.133:6378;
	&#125;
	server&#123;
		listen 81;
		proxy_pass redisbackend;
	&#125;
&#125;</code></pre>

<h3 id="11-7tomcat"><a href="#11-7tomcat" class="headerlink" title="11.7tomcat"></a>11.7tomcat</h3><blockquote>
<p>tar -zxf tomcat.tar.gz</p>
<p>cd tomcat&#x2F;bin </p>
<p>.&#x2F;startup</p>
</blockquote>
<h2 id="12-Nginx缓存集成"><a href="#12-Nginx缓存集成" class="headerlink" title="12.Nginx缓存集成"></a>12.Nginx缓存集成</h2><h3 id="12-1proxy-cache-path"><a href="#12-1proxy-cache-path" class="headerlink" title="12.1proxy_cache_path"></a>12.1proxy_cache_path</h3><blockquote>
<p>用于指定缓存文件的存放路径</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_path path [levels&#x3D;number]<br>keys_zone&#x3D;zone_name:zone_size [inactive&#x3D;time][max_size&#x3D;size];</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>——</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody></table>
<p>path:缓存路径存放地址</p>
<p>levels:指定缓存空间对应的目录，可以设置3层。每层取1|2</p>
<blockquote>
<p>232563c4a42a4c5f4234b324e273d20d</p>
<p>levels&#x3D;1:2     缓存空间有两层，第一次一个字母，第二次两个</p>
<p>levels&#x3D;1:2           &#x2F;usr&#x2F;local&#x2F;proxy_cache&#x2F;d&#x2F;20</p>
<p>levels&#x3D;1:2:2      &#x2F;usr&#x2F;local&#x2F;proxy_cache&#x2F;d&#x2F;20&#x2F;d3</p>
</blockquote>
<p>keys_zone  指定名称和大小</p>
<blockquote>
<p>keys_zone&#x3D;itcast:200m</p>
</blockquote>
<p>inactive:指定缓存数据多长时间未被访问就会删除</p>
<blockquote>
<p>inactive&#x3D;1d 1天没被访问就会删除</p>
</blockquote>
<p>max_size设置最大缓存空间</p>
<blockquote>
<p>max_size&#x3D;20g</p>
</blockquote>
<blockquote>
<p>proxy_cache_path &#x2F;usr&#x2F;local&#x2F;proxy_cache levels&#x3D;1:2 keys_zone&#x3D;richu:200m inactive&#x3D;1d max_size&#x3D;20g;</p>
</blockquote>
<h3 id="12-2proxy-cache"><a href="#12-2proxy-cache" class="headerlink" title="12.2proxy_cache"></a>12.2proxy_cache</h3><blockquote>
<p>开启关闭代理缓存</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache off | on</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache off</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="12-4proxy-cache-key"><a href="#12-4proxy-cache-key" class="headerlink" title="12.4proxy_cache_key"></a>12.4proxy_cache_key</h3><blockquote>
<p>设置web缓存的key值,Nginx会根据key值MD5哈希缓存</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_key key</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_key $scheme$proxy_host$request_uri</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="12-5proxy-cache-valid"><a href="#12-5proxy-cache-valid" class="headerlink" title="12.5proxy_cache_valid"></a>12.5proxy_cache_valid</h3><blockquote>
<p>不同状态码的URL设置不同的缓存时间</p>
</blockquote>
<blockquote>
<p>proxy_cache_valid 200 302 10m;</p>
<p>proxy_cache_valid 404 1m;</p>
<p>proxy_cache_valid any 1m;</p>
<p>200 302 缓存十分钟 404缓存1分钟</p>
</blockquote>
<h3 id="12-6proxy-cache-min-uses"><a href="#12-6proxy-cache-min-uses" class="headerlink" title="12.6proxy_cache_min_uses"></a>12.6proxy_cache_min_uses</h3><blockquote>
<p>设置资源被访问多少次之后被缓存</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_min_uses number;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_min_uses 1</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="12-7proxy-cache-method"><a href="#12-7proxy-cache-method" class="headerlink" title="12.7proxy_cache_method"></a>12.7proxy_cache_method</h3><blockquote>
<p>缓存哪些http方法</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_method GET|HEAD|POST</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_method GET HEAD;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="12-8Nginx缓存的清除"><a href="#12-8Nginx缓存的清除" class="headerlink" title="12.8Nginx缓存的清除"></a>12.8Nginx缓存的清除</h3><blockquote>
<p>1删除资源文件夹</p>
<p>rm -rf &#x2F;usr&#x2F;local&#x2F;proxy_cache</p>
</blockquote>
<blockquote>
<p>2安装第三方模块</p>
<p>tar -zxf ngx_cache_purge-2.3.tar.gz</p>
<p>mv ngx_cache_purge-2.3 purge</p>
</blockquote>
<pre><code class="highlight plaintext">--prefix=/usr/local/nginx --sbin-path=/usr/local/nginx/sbin/
nginx --modules-path=/usr/local/nginx/modules --conf-path=/usr/
local/nginx/conf/nginx.conf --error-log-path=/usr/local/nginx/
logs/error.log --http-log-path=/usr/local/nginx/logs/access.log 
--pid-path=/usr/local/nginx/logs/nginx.pid --lock-path=/usr/local/
nginx/logs/nginx.lock --with-http_gzip_static_module 
--with-http_ssl_module --add-module=/root/nginx/module/
fair --with-stream</code></pre>

<pre><code class="highlight plaintext">./configure --prefix=/usr/local/nginx --sbin-path=/usr/local/nginx/
sbin/nginx --modules-path=/usr/local/nginx/modules --conf-path=/
usr/local/nginx/conf/nginx.conf --error-log-path=/usr/local/nginx/
logs/error.log --http-log-path=/usr/local/nginx/logs/access.log 
--pid-path=/usr/local/nginx/logs/nginx.pid --lock-path=/usr/local/
nginx/logs/nginx.lock --with-http_gzip_static_module 
--with-http_ssl_module --add-module=/root/nginx/module/
fair --with-stream --add-module=/root/nginx/module/purge</code></pre>

<blockquote>
<p>make</p>
<p>mv nginx nginxold</p>
<p>cp nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin</p>
<p>make upgrade</p>
</blockquote>
<h3 id="12-9使用Nginx缓存的清除"><a href="#12-9使用Nginx缓存的清除" class="headerlink" title="12.9使用Nginx缓存的清除"></a>12.9使用Nginx缓存的清除</h3><pre><code class="highlight plaintext">location ~ /purge(/.*) &#123;
	proxy_cache_purge richu
    (proxy_cache指定的名称) richu
    (proxy_cache_key指定的名称)
&#125;</code></pre>

<h2 id="13-设置资源不缓存"><a href="#13-设置资源不缓存" class="headerlink" title="13.设置资源不缓存"></a>13.设置资源不缓存</h2><h3 id="13-1proxy-no-cache"><a href="#13-1proxy-no-cache" class="headerlink" title="13.1proxy_no_cache"></a>13.1proxy_no_cache</h3><blockquote>
<p>指定不缓存的条件</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_no_cache string …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—–</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="13-2proxy-caxhe-bypass"><a href="#13-2proxy-caxhe-bypass" class="headerlink" title="13.2proxy_caxhe_bypass"></a>13.2proxy_caxhe_bypass</h3><blockquote>
<p>不从缓存中获取数据</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_caxhe_bypass string;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—–</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<blockquote>
<p>只要有1个不为0或不为非空则成立</p>
</blockquote>
<h3 id="13-3变量名"><a href="#13-3变量名" class="headerlink" title="13.3变量名"></a>13.3变量名</h3><blockquote>
<p>$cookie_nocache  当前请求中的cookie中键为nocache对应的值</p>
<p>$arg_nocache    $arg_comment   当前请求中的参数中属性名为nocache，comment对应的值</p>
</blockquote>
<h3 id="13-4动静分离"><a href="#13-4动静分离" class="headerlink" title="13.4动静分离"></a>13.4动静分离</h3><blockquote>
<p>动：后台应用程序的业务处理</p>
<p>静：网站的静态资源（html,javascript,css,Images等文件）</p>
</blockquote>
<blockquote>
<p>打包war放入tomcat的webapps目录下</p>
</blockquote>
<h2 id="14KeepAlive的安装"><a href="#14KeepAlive的安装" class="headerlink" title="14KeepAlive的安装"></a>14KeepAlive的安装</h2><h3 id="14-1配置安装"><a href="#14-1配置安装" class="headerlink" title="14.1配置安装"></a>14.1配置安装</h3><p>1.下载</p>
<p><a target="_blank" rel="noopener" href="https://keepalived.org/download.html">Keepalived for Linux</a></p>
<p>2.解压缩</p>
<blockquote>
<p>tar -zxf keepalives.tar.gz</p>
</blockquote>
<p>3.配置</p>
<blockquote>
<p>.&#x2F;configure –sysconf&#x3D;&#x2F;etc –prefix&#x3D;&#x2F;usr&#x2F;local</p>
</blockquote>
<p>4.编译安装</p>
<blockquote>
<p>make &amp;&amp; make install</p>
</blockquote>
<blockquote>
<p>&#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf文件 配置文件</p>
<p>&#x2F;usr&#x2F;local&#x2F;sbin   二进制启动文件</p>
</blockquote>
<p>2.配置文件</p>
<pre><code class="highlight plaintext">global_defs &#123;
   notification_email &#123;       #出问题会给下面的邮件发送消息
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   &#125;
   
   #从哪个邮件发送消息
   notification_email_from Alexandre.Cassen@firewall.loc  
   
   
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   router_id LVS_DEVEL       #唯一标识
   vrrp_skip_check_adv_addr
   vrrp_strict
   vrrp_garp_interval 0
   vrrp_gna_interval 0
&#125;


vrrp_instance VI_1 &#123;
    state MASTER	#主
    interface eth0   #网卡名称
    virtual_router_id 51    
    priority 100   #指定优先级
    advert_int 1    #发送健康状况的时间间隔
    authentication &#123;
        auth_type PASS
        auth_pass 1111
    &#125;
    virtual_ipaddress &#123;
        192.168.200.16
        192.168.200.17
        192.168.200.18
    &#125;
</code></pre>

<h3 id="14-2vrrp-script"><a href="#14-2vrrp-script" class="headerlink" title="14.2vrrp_script"></a>14.2vrrp_script</h3><blockquote>
<p>自动判断nginx服务的状况</p>
</blockquote>
<p>1.keepalived配置文件</p>
<pre><code class="highlight plaintext">vrrp_scipt 脚本名称
&#123;
	script &quot;脚本位置&quot;
	interval 3 #执行时间间隔
	weight -20 #动态调整vrrp_instance的优先级
&#125;</code></pre>

<pre><code class="highlight bash"><span class="meta">#!/bin/bash</span>
num=`ps -C nginx --no-header | <span class="built_in">wc</span> -l`
<span class="keyword">if</span> [<span class="variable">$num</span> -eq 0];<span class="keyword">then</span>
/usr/local/nginx/sbin/nginx
<span class="built_in">sleep</span> 2
<span class="keyword">if</span> [`ps -C nginx --no-header | <span class="built_in">wc</span> -l ` -eq 0];<span class="keyword">then</span>
 	<span class="built_in">kill</span> keepalived
  <span class="keyword">fi</span>
<span class="keyword">fi</span></code></pre>

<h2 id="15-使用Nginx制作下载站点"><a href="#15-使用Nginx制作下载站点" class="headerlink" title="15.使用Nginx制作下载站点"></a>15.使用Nginx制作下载站点</h2><p>ngx_http_autoindex_module模块</p>
<p>(1)autoindex:启用或禁用目录列表输出</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>autoindex on|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>autoindex off</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>(2)autoindex_exact_size:对应HTML格式，指定是否在目录列表展示文件的详细大小</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>autoindex_exact_size on | off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>autoindex_exact_size on</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>(3)autoindex_format:设置目录列表的格式</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>autoindex_format html|xml|json|jsonp</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>autoindex_format html</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>(4)autoindex_location:对应HTML格式，是否在目录列表上显示时间</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>autoindex_location on |off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>autoindex_location off</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">location /download&#123;
	root /usr/local/download;
	autoindex on;
	autoindex_exact_size on;
	autoindex_format html;
	autoindex_location on;
&#125;</code></pre>

<h2 id="16Nginx用户认证"><a href="#16Nginx用户认证" class="headerlink" title="16Nginx用户认证"></a>16Nginx用户认证</h2><p>ngx_http_auth_basic_module模块</p>
<p>(1)auth_basic:使用”HTTP基本认证”协议启用用户名和密码的验证</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>auth_basic on |off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>auth_basic off</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location、limit_except</td>
</tr>
</tbody></table>
<p>(2)auth_basic_user_file:指定用户名和文件所在的位置</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>auth_basic_user_file file</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—–</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location、limit_except</td>
</tr>
</tbody></table>
<pre><code class="highlight plaintext">auth_basic &#x27;please input your password&#x27;
auth_basic_user_file htpassword</code></pre>

<blockquote>
<p>使用一个工具生成密码</p>
</blockquote>
<pre><code class="highlight plaintext">yum install -y httpd-tools</code></pre>

<pre><code class="highlight plaintext">htpasswd -c /usr/local/nginx/conf/htpasswd name  //生成新文件和密码
htpasswd -b /usr/local/nginx/conf/htpasswd name password  //追加密码
htpasswd -D /usr/local/nginx/conf/htpasswd name   //删除指定用户名
htpasswd -v /usr/local/nginx/conf/htpasswd name   //验证密码</code></pre>
        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/2024/08/31/Java%20Web/">Java Web</a></li>
                
                
                    <li>下一篇: 看完啦 (つд⊂)</li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/Nginx/" rel="tag">Nginx</a><a class="-none-link" href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag">运维</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://p1.meituan.net/csc/949ad40707d4b4bab7e2ebafbd649aa8211830.jpg" alt="日初" />
            </figure>
        
            <div class="author-info">
                <h4>日初</h4>
                <p>一个什么都学的建模动画编程爱好者</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <a class="to-top" href="#"></a>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/10/21/Andriod/">Android</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/19/Go/">Go</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/16/MybatisPlus/">MybatisPlus</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/15/SpringCloud/">Spring Cloud</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/12/SpringMVC/">SpringMVC</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/09/Linux/">Linux</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">十月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">八月 2024</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/CSS/" style="font-size: 20px;">CSS</a> <a href="/tags/Go/" style="font-size: 20px;">Go</a> <a href="/tags/Go-Web/" style="font-size: 20px;">Go Web</a> <a href="/tags/JS/" style="font-size: 20px;">JS</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Java-Web/" style="font-size: 20px;">Java Web</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/MySql/" style="font-size: 20px;">MySql</a> <a href="/tags/MybatisPlus/" style="font-size: 20px;">MybatisPlus</a> <a href="/tags/Nginx/" style="font-size: 20px;">Nginx</a> <a href="/tags/React/" style="font-size: 20px;">React</a> <a href="/tags/Spring-Cloud/" style="font-size: 20px;">Spring Cloud</a> <a href="/tags/Vue/" style="font-size: 20px;">Vue</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 20px;">前端</a> <a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 20px;">运维</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2024 <a href="/">Richu</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":true,"night":false});</script>

  </body>
</html>
